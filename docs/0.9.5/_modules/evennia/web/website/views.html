
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.web.website.views &#8212; Evennia 0.9.5 documentation</title>
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia 0.9.5</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.web.website.views</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.web.website.views</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file contains the generic, assorted views that don&#39;t fall under one of the other applications.</span>
<span class="sd">Views are django&#39;s way of processing e.g. html templates on the fly.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">django.contrib.admin.sites</span> <span class="kn">import</span> <span class="n">site</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.mixins</span> <span class="kn">import</span> <span class="n">LoginRequiredMixin</span>
<span class="kn">from</span> <span class="nn">django.contrib.admin.views.decorators</span> <span class="kn">import</span> <span class="n">staff_member_required</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">PermissionDenied</span>
<span class="kn">from</span> <span class="nn">django.db.models.functions</span> <span class="kn">import</span> <span class="n">Lower</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse_lazy</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span><span class="p">,</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">DetailView</span>
<span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="kn">import</span> <span class="n">RedirectView</span>
<span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="kn">import</span> <span class="n">CreateView</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">,</span> <span class="n">DeleteView</span>

<span class="kn">from</span> <span class="nn">evennia</span> <span class="kn">import</span> <span class="n">SESSION_HANDLER</span>
<span class="kn">from</span> <span class="nn">evennia.help.models</span> <span class="kn">import</span> <span class="n">HelpEntry</span>
<span class="kn">from</span> <span class="nn">evennia.objects.models</span> <span class="kn">import</span> <span class="n">ObjectDB</span>
<span class="kn">from</span> <span class="nn">evennia.accounts.models</span> <span class="kn">import</span> <span class="n">AccountDB</span>
<span class="kn">from</span> <span class="nn">evennia.utils</span> <span class="kn">import</span> <span class="n">class_from_module</span>
<span class="kn">from</span> <span class="nn">evennia.utils.logger</span> <span class="kn">import</span> <span class="n">tail_log_file</span>
<span class="kn">from</span> <span class="nn">evennia.web.website</span> <span class="kn">import</span> <span class="n">forms</span> <span class="k">as</span> <span class="n">website_forms</span>

<span class="kn">from</span> <span class="nn">django.utils.text</span> <span class="kn">import</span> <span class="n">slugify</span>

<span class="n">_BASE_CHAR_TYPECLASS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span>

<span class="c1"># typeclass fallbacks</span>

<span class="k">def</span> <span class="nf">_gamestats</span><span class="p">():</span>
    <span class="c1"># Some misc. configurable stuff.</span>
    <span class="c1"># TODO: Move this to either SQL or settings.py based configuration.</span>
    <span class="n">fpage_account_limit</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># A QuerySet of the most recently connected accounts.</span>
    <span class="n">recent_users</span> <span class="o">=</span> <span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_recently_connected_accounts</span><span class="p">()[:</span><span class="n">fpage_account_limit</span><span class="p">]</span>
    <span class="n">nplyrs_conn_recent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_users</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span>
    <span class="n">nplyrs</span> <span class="o">=</span> <span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">num_total_accounts</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span>
    <span class="n">nplyrs_reg_recent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_recently_created_accounts</span><span class="p">())</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span>
    <span class="n">nsess</span> <span class="o">=</span> <span class="n">SESSION_HANDLER</span><span class="o">.</span><span class="n">account_count</span><span class="p">()</span>
    <span class="c1"># nsess = len(AccountDB.objects.get_connected_accounts()) or &quot;no one&quot;</span>

    <span class="n">nobjs</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">nobjs</span> <span class="o">=</span> <span class="n">nobjs</span> <span class="ow">or</span> <span class="mi">1</span>  <span class="c1"># fix zero-div error with empty database</span>
    <span class="n">Character</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span><span class="p">,</span>
                                  <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_CHARACTER_TYPECLASS</span><span class="p">)</span>
    <span class="n">nchars</span> <span class="o">=</span> <span class="n">Character</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all_family</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">Room</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_ROOM_TYPECLASS</span><span class="p">,</span>
                             <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_ROOM_TYPECLASS</span><span class="p">)</span>
    <span class="n">nrooms</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all_family</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">Exit</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_EXIT_TYPECLASS</span><span class="p">,</span>
                             <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_EXIT_TYPECLASS</span><span class="p">)</span>
    <span class="n">nexits</span> <span class="o">=</span> <span class="n">Exit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all_family</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">nothers</span> <span class="o">=</span> <span class="n">nobjs</span> <span class="o">-</span> <span class="n">nchars</span> <span class="o">-</span> <span class="n">nrooms</span> <span class="o">-</span> <span class="n">nexits</span>

    <span class="n">pagevars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Front Page&quot;</span><span class="p">,</span>
        <span class="s2">&quot;accounts_connected_recent&quot;</span><span class="p">:</span> <span class="n">recent_users</span><span class="p">,</span>
        <span class="s2">&quot;num_accounts_connected&quot;</span><span class="p">:</span> <span class="n">nsess</span> <span class="ow">or</span> <span class="s2">&quot;no one&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_accounts_registered&quot;</span><span class="p">:</span> <span class="n">nplyrs</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_accounts_connected_recent&quot;</span><span class="p">:</span> <span class="n">nplyrs_conn_recent</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_accounts_registered_recent&quot;</span><span class="p">:</span> <span class="n">nplyrs_reg_recent</span> <span class="ow">or</span> <span class="s2">&quot;no one&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_rooms&quot;</span><span class="p">:</span> <span class="n">nrooms</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_exits&quot;</span><span class="p">:</span> <span class="n">nexits</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_objects&quot;</span><span class="p">:</span> <span class="n">nobjs</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_characters&quot;</span><span class="p">:</span> <span class="n">nchars</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_others&quot;</span><span class="p">:</span> <span class="n">nothers</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">pagevars</span>


<div class="viewcode-block" id="to_be_implemented"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.to_be_implemented">[docs]</a><span class="k">def</span> <span class="nf">to_be_implemented</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A notice letting the user know that this particular feature hasn&#39;t been</span>
<span class="sd">    implemented yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pagevars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="s2">&quot;To Be Implemented...&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;tbi.html&quot;</span><span class="p">,</span> <span class="n">pagevars</span><span class="p">)</span></div>


<div class="viewcode-block" id="evennia_admin"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.evennia_admin">[docs]</a><span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">evennia_admin</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helpful Evennia-specific admin page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;evennia_admin.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;accountdb&quot;</span><span class="p">:</span> <span class="n">AccountDB</span><span class="p">})</span></div>


<div class="viewcode-block" id="admin_wrapper"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.admin_wrapper">[docs]</a><span class="k">def</span> <span class="nf">admin_wrapper</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper that allows us to properly use the base Django admin site, if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">staff_member_required</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">index</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1"># Class-based views</span>
<span class="c1">#</span>


<div class="viewcode-block" id="EvenniaIndexView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.EvenniaIndexView">[docs]</a><span class="k">class</span> <span class="nc">EvenniaIndexView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a basic example of a Django class-based view, which are functionally</span>
<span class="sd">    very similar to Evennia Commands but differ in structure. Commands are used</span>
<span class="sd">    to interface with users using a terminal client. Views are used to interface</span>
<span class="sd">    with users using a web browser.</span>

<span class="sd">    To use a class-based view, you need to have written a template in HTML, and</span>
<span class="sd">    then you write a view like this to tell Django what values to display on it.</span>

<span class="sd">    While there are simpler ways of writing views using plain functions (and</span>
<span class="sd">    Evennia currently contains a few examples of them), just like Commands,</span>
<span class="sd">    writing views as classes provides you with more flexibility-- you can extend</span>
<span class="sd">    classes and change things to suit your needs rather than having to copy and</span>
<span class="sd">    paste entire code blocks over and over. Django also comes with many default</span>
<span class="sd">    views for displaying things, all of them implemented as classes.</span>

<span class="sd">    This particular example displays the index page.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Tell the view what HTML template to use for the page</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/index.html&quot;</span>

    <span class="c1"># This method tells the view what data should be displayed on the template.</span>
<div class="viewcode-block" id="EvenniaIndexView.get_context_data"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.EvenniaIndexView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a common Django method. Think of this as the website</span>
<span class="sd">        equivalent of the Evennia Command.func() method.</span>

<span class="sd">        If you just want to display a static page with no customization, you</span>
<span class="sd">        don&#39;t need to define this method-- just create a view, define</span>
<span class="sd">        template_name and you&#39;re done.</span>

<span class="sd">        The only catch here is that if you extend or overwrite this method,</span>
<span class="sd">        you&#39;ll always want to make sure you call the parent method to get a</span>
<span class="sd">        context object. It&#39;s just a dict, but it comes prepopulated with all</span>
<span class="sd">        sorts of background data intended for display on the page.</span>

<span class="sd">        You can do whatever you want to it, but it must be returned at the end</span>
<span class="sd">        of this method.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            any (any): Passed through.</span>

<span class="sd">        Returns:</span>
<span class="sd">            context (dict): Dictionary of data you want to display on the page.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Always call the base implementation first to get a context object</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">EvenniaIndexView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Add game statistics and other pagevars</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_gamestats</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="TypeclassMixin"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.TypeclassMixin">[docs]</a><span class="k">class</span> <span class="nc">TypeclassMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a &quot;mixin&quot;, a modifier of sorts.</span>

<span class="sd">    Django views typically work with classes called &quot;models.&quot; Evennia objects</span>
<span class="sd">    are an enhancement upon these Django models and are called &quot;typeclasses.&quot;</span>
<span class="sd">    But Django itself has no idea what a &quot;typeclass&quot; is.</span>

<span class="sd">    For the sake of mitigating confusion, any view class with this in its</span>
<span class="sd">    inheritance list will be modified to work with Evennia Typeclass objects or</span>
<span class="sd">    Django models interchangeably.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">typeclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

    <span class="nd">@typeclass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">typeclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="EvenniaCreateView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.EvenniaCreateView">[docs]</a><span class="k">class</span> <span class="nc">EvenniaCreateView</span><span class="p">(</span><span class="n">CreateView</span><span class="p">,</span> <span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view extends Django&#39;s default CreateView.</span>

<span class="sd">    CreateView is used for creating new objects, be they Accounts, Characters or</span>
<span class="sd">    otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Makes sure the page has a sensible title.</span>
        <span class="k">return</span> <span class="s2">&quot;Create </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span></div>


<div class="viewcode-block" id="EvenniaDetailView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.EvenniaDetailView">[docs]</a><span class="k">class</span> <span class="nc">EvenniaDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">,</span> <span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view extends Django&#39;s default DetailView.</span>

<span class="sd">    DetailView is used for displaying objects, be they Accounts, Characters or</span>
<span class="sd">    otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Makes sure the page has a sensible title.</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Detail&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span></div>


<div class="viewcode-block" id="EvenniaUpdateView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.EvenniaUpdateView">[docs]</a><span class="k">class</span> <span class="nc">EvenniaUpdateView</span><span class="p">(</span><span class="n">UpdateView</span><span class="p">,</span> <span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view extends Django&#39;s default UpdateView.</span>

<span class="sd">    UpdateView is used for updating objects, be they Accounts, Characters or</span>
<span class="sd">    otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Makes sure the page has a sensible title.</span>
        <span class="k">return</span> <span class="s2">&quot;Update </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span></div>


<div class="viewcode-block" id="EvenniaDeleteView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.EvenniaDeleteView">[docs]</a><span class="k">class</span> <span class="nc">EvenniaDeleteView</span><span class="p">(</span><span class="n">DeleteView</span><span class="p">,</span> <span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view extends Django&#39;s default DeleteView.</span>

<span class="sd">    DeleteView is used for deleting objects, be they Accounts, Characters or</span>
<span class="sd">    otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Makes sure the page has a sensible title.</span>
        <span class="k">return</span> <span class="s2">&quot;Delete </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span></div>


<span class="c1">#</span>
<span class="c1"># Object views</span>
<span class="c1">#</span>


<div class="viewcode-block" id="ObjectDetailView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectDetailView">[docs]</a><span class="k">class</span> <span class="nc">ObjectDetailView</span><span class="p">(</span><span class="n">EvenniaDetailView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an important view.</span>

<span class="sd">    Any view you write that deals with displaying, updating or deleting a</span>
<span class="sd">    specific object will want to inherit from this. It provides the mechanisms</span>
<span class="sd">    by which to retrieve the object and make sure the user requesting it has</span>
<span class="sd">    permissions to actually *do* things to it.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="c1">#</span>
    <span class="c1"># Choose what class of object this view will display. Note that this should</span>
    <span class="c1"># be an actual Python class (i.e. do `from typeclasses.characters import</span>
    <span class="c1"># Character`, then put `Character`), not an Evennia typeclass path</span>
    <span class="c1"># (i.e. `typeclasses.characters.Character`).</span>
    <span class="c1">#</span>
    <span class="c1"># So when you extend it, this line should look simple, like:</span>
    <span class="c1"># model = Object</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_OBJECT_TYPECLASS</span><span class="p">,</span>
                              <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_OBJECT_TYPECLASS</span><span class="p">)</span>

    <span class="c1"># What HTML template you wish to use to display this page.</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/object_detail.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="c1">#</span>
    <span class="c1"># What lock type to check for the requesting user, authenticated or not.</span>
    <span class="c1"># https://github.com/evennia/evennia/wiki/Locks#valid-access_types</span>
    <span class="n">access_type</span> <span class="o">=</span> <span class="s2">&quot;view&quot;</span>

    <span class="c1"># What attributes of the object you wish to display on the page. Model-level</span>
    <span class="c1"># attributes will take precedence over identically-named db.attributes!</span>
    <span class="c1"># The order you specify here will be followed.</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="ObjectDetailView.get_context_data"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds an &#39;attributes&#39; list to the request context consisting of the</span>
<span class="sd">        attributes specified at the class level, and in the order provided.</span>

<span class="sd">        Django views do not provide a way to reference dynamic attributes, so</span>
<span class="sd">        we have to grab them all before we render the template.</span>

<span class="sd">        Returns:</span>
<span class="sd">            context (dict): Django context object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the base Django context object</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ObjectDetailView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Get the object in question</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="c1"># Create an ordered dictionary to contain the attribute map</span>
        <span class="n">attribute_list</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="c1"># Check if the attribute is a core fieldname (name, desc)</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">_property_names</span><span class="p">:</span>
                <span class="n">attribute_list</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">title</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Check if the attribute is a db attribute (char1.db.favorite_color)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attribute_list</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">title</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Add our attribute map to the Django request context, so it gets</span>
        <span class="c1"># displayed on the template</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;attribute_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute_list</span>

        <span class="c1"># Return the comprehensive context object</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="ObjectDetailView.get_object"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectDetailView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override of Django hook that provides some important Evennia-specific</span>
<span class="sd">        functionality.</span>

<span class="sd">        Evennia does not natively store slugs, so where a slug is provided,</span>
<span class="sd">        calculate the same for the object and make sure it matches.</span>

<span class="sd">        This also checks to make sure the user has access to view/edit/delete</span>
<span class="sd">        this object!</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># A queryset can be provided to pre-emptively limit what objects can</span>
        <span class="c1"># possibly be returned. For example, you can supply a queryset that</span>
        <span class="c1"># only returns objects whose name begins with &quot;a&quot;.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="c1"># Get the object, ignoring all checks and filters for now</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">))</span>

        <span class="c1"># Check if this object was requested in a valid manner</span>
        <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slug_url_kwarg</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span>
                <span class="s2">&quot;No </span><span class="si">%(verbose_name)s</span><span class="s2"> found matching the query&quot;</span>
                <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Check if the requestor account has permissions to access object</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s2">&quot;You are not authorized to </span><span class="si">%s</span><span class="s2"> this object.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_type</span><span class="p">)</span>

        <span class="c1"># Get the object, if it is in the specified queryset</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ObjectDetailView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span></div></div>


<div class="viewcode-block" id="ObjectCreateView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectCreateView">[docs]</a><span class="k">class</span> <span class="nc">ObjectCreateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">EvenniaCreateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an important view.</span>

<span class="sd">    Any view you write that deals with creating a specific object will want to</span>
<span class="sd">    inherit from this. It provides the mechanisms by which to make sure the user</span>
<span class="sd">    requesting creation of an object is authenticated, and provides a sane</span>
<span class="sd">    default title for the page.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_OBJECT_TYPECLASS</span><span class="p">,</span>
                              <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_OBJECT_TYPECLASS</span><span class="p">)</span></div>


<div class="viewcode-block" id="ObjectDeleteView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectDeleteView">[docs]</a><span class="k">class</span> <span class="nc">ObjectDeleteView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ObjectDetailView</span><span class="p">,</span> <span class="n">EvenniaDeleteView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an important view for obvious reasons!</span>

<span class="sd">    Any view you write that deals with deleting a specific object will want to</span>
<span class="sd">    inherit from this. It provides the mechanisms by which to make sure the user</span>
<span class="sd">    requesting deletion of an object is authenticated, and that they have</span>
<span class="sd">    permissions to delete the requested object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_OBJECT_TYPECLASS</span><span class="p">,</span>
                              <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_OBJECT_TYPECLASS</span><span class="p">)</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/object_confirm_delete.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">access_type</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>

<div class="viewcode-block" id="ObjectDeleteView.delete"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectDeleteView.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls the delete() method on the fetched object and then</span>
<span class="sd">        redirects to the success URL.</span>

<span class="sd">        We extend this so we can capture the name for the sake of confirmation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the object in question. ObjectDetailView.get_object() will also</span>
        <span class="c1"># check to make sure the current user (authenticated or not) has</span>
        <span class="c1"># permission to delete it!</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">())</span>

        <span class="c1"># Perform the actual deletion (the parent class handles this, which will</span>
        <span class="c1"># in turn call the delete() method on the object)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ObjectDeleteView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Notify the user of the deletion</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Successfully deleted &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div></div>


<div class="viewcode-block" id="ObjectUpdateView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectUpdateView">[docs]</a><span class="k">class</span> <span class="nc">ObjectUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ObjectDetailView</span><span class="p">,</span> <span class="n">EvenniaUpdateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an important view.</span>

<span class="sd">    Any view you write that deals with updating a specific object will want to</span>
<span class="sd">    inherit from this. It provides the mechanisms by which to make sure the user</span>
<span class="sd">    requesting editing of an object is authenticated, and that they have</span>
<span class="sd">    permissions to edit the requested object.</span>

<span class="sd">    This functions slightly different from default Django UpdateViews in that</span>
<span class="sd">    it does not update core model fields, *only* object attributes!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_OBJECT_TYPECLASS</span><span class="p">,</span>
                              <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_OBJECT_TYPECLASS</span><span class="p">)</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">access_type</span> <span class="o">=</span> <span class="s2">&quot;edit&quot;</span>

<div class="viewcode-block" id="ObjectUpdateView.get_success_url"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectUpdateView.get_success_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook.</span>

<span class="sd">        Can be overridden to return any URL you want to redirect the user to</span>
<span class="sd">        after the object is successfully updated, but by default it goes to the</span>
<span class="sd">        object detail page so the user can see their changes reflected.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_url</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_url</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">web_get_detail_url</span><span class="p">()</span></div>

<div class="viewcode-block" id="ObjectUpdateView.get_initial"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectUpdateView.get_initial">[docs]</a>    <span class="k">def</span> <span class="nf">get_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook, modified for Evennia.</span>

<span class="sd">        Prepopulates the update form field values based on object db attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            data (dict): Dictionary of key:value pairs containing initial form</span>
<span class="sd">                data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the object we want to update</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="c1"># Get attributes</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">base_fields</span><span class="p">}</span>

        <span class="c1"># Get model fields</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">fields</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ObjectUpdateView.form_valid"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ObjectUpdateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override of Django hook.</span>

<span class="sd">        Updates object attributes based on values submitted.</span>

<span class="sd">        This is run when the form is submitted and the data on it is deemed</span>
<span class="sd">        valid-- all values are within expected ranges, all strings contain</span>
<span class="sd">        valid characters and lengths, etc.</span>

<span class="sd">        This method is only called if all values for the fields submitted</span>
<span class="sd">        passed form validation, so at this point we can assume the data is</span>
<span class="sd">        validated and sanitized.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the attributes after they&#39;ve been cleaned and validated</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>

        <span class="c1"># Update the object attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Successfully updated &#39;</span><span class="si">%s</span><span class="s2">&#39; for </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="p">))</span>

        <span class="c1"># Do not return super().form_valid; we don&#39;t want to update the model</span>
        <span class="c1"># instance, just its attributes.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">())</span></div></div>


<span class="c1">#</span>
<span class="c1"># Account views</span>
<span class="c1">#</span>


<div class="viewcode-block" id="AccountMixin"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.AccountMixin">[docs]</a><span class="k">class</span> <span class="nc">AccountMixin</span><span class="p">(</span><span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a &quot;mixin&quot;, a modifier of sorts.</span>

<span class="sd">    Any view class with this in its inheritance list will be modified to work</span>
<span class="sd">    with Account objects instead of generic Objects or otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_ACCOUNT_TYPECLASS</span><span class="p">,</span>
                              <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_ACCOUNT_TYPECLASS</span><span class="p">)</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">website_forms</span><span class="o">.</span><span class="n">AccountForm</span></div>


<div class="viewcode-block" id="AccountCreateView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.AccountCreateView">[docs]</a><span class="k">class</span> <span class="nc">AccountCreateView</span><span class="p">(</span><span class="n">AccountMixin</span><span class="p">,</span> <span class="n">EvenniaCreateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Account creation view.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/registration/register.html&quot;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AccountCreateView.form_valid"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.AccountCreateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook, modified for Evennia.</span>

<span class="sd">        This hook is called after a valid form is submitted.</span>

<span class="sd">        When an account creation form is submitted and the data is deemed valid,</span>
<span class="sd">        proceeds with creating the Account object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get values provided</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;password1&quot;</span><span class="p">]</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Create account</span>
        <span class="n">account</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>

        <span class="c1"># If unsuccessful, display error messages to user</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="p">:</span>
            <span class="p">[</span><span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">errs</span><span class="p">]</span>

            <span class="c1"># Call the Django &quot;form failure&quot; hook</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_invalid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

        <span class="c1"># Inform user of success</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;Your account &#39;</span><span class="si">%s</span><span class="s2">&#39; was successfully created! &quot;</span>
            <span class="s2">&quot;You may log in using it now.&quot;</span> <span class="o">%</span> <span class="n">account</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Redirect the user to the login page</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_url</span><span class="p">)</span></div></div>


<span class="c1">#</span>
<span class="c1"># Character views</span>
<span class="c1">#</span>


<div class="viewcode-block" id="CharacterMixin"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterMixin">[docs]</a><span class="k">class</span> <span class="nc">CharacterMixin</span><span class="p">(</span><span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a &quot;mixin&quot;, a modifier of sorts.</span>

<span class="sd">    Any view class with this in its inheritance list will be modified to work</span>
<span class="sd">    with Character objects instead of generic Objects or otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span><span class="p">,</span>
                              <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_CHARACTER_TYPECLASS</span><span class="p">)</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">website_forms</span><span class="o">.</span><span class="n">CharacterForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;character-manage&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CharacterMixin.get_queryset"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterMixin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will override the Django get_queryset method to only</span>
<span class="sd">        return a list of characters associated with the current authenticated</span>
<span class="sd">        user.</span>

<span class="sd">        Returns:</span>
<span class="sd">            queryset (QuerySet): Django queryset for use in the given view.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get IDs of characters owned by account</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">characters</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>

        <span class="c1"># Return a queryset consisting of those characters</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="CharacterListView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterListView">[docs]</a><span class="k">class</span> <span class="nc">CharacterListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">CharacterMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view provides a mechanism by which a logged-in player can view a list</span>
<span class="sd">    of all other characters.</span>

<span class="sd">    This view requires authentication by default as a nominal effort to prevent</span>
<span class="sd">    human stalkers and automated bots/scrapers from harvesting data on your users.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/character_list.html&quot;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Character List&quot;</span>
    <span class="n">access_type</span> <span class="o">=</span> <span class="s2">&quot;view&quot;</span>

<div class="viewcode-block" id="CharacterListView.get_queryset"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will override the Django get_queryset method to return a</span>
<span class="sd">        list of all characters (filtered/sorted) instead of just those limited</span>
<span class="sd">        to the account.</span>

<span class="sd">        Returns:</span>
<span class="sd">            queryset (QuerySet): Django queryset for use in the given view.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="c1"># Return a queryset consisting of characters the user is allowed to</span>
        <span class="c1"># see.</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_type</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="CharacterPuppetView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterPuppetView">[docs]</a><span class="k">class</span> <span class="nc">CharacterPuppetView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">CharacterMixin</span><span class="p">,</span> <span class="n">RedirectView</span><span class="p">,</span> <span class="n">ObjectDetailView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view provides a mechanism by which a logged-in player can &quot;puppet&quot; one</span>
<span class="sd">    of their characters within the context of the website.</span>

<span class="sd">    It also ensures that any user attempting to puppet something is logged in,</span>
<span class="sd">    and that their intended puppet is one that they own.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CharacterPuppetView.get_redirect_url"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterPuppetView.get_redirect_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_redirect_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook.</span>

<span class="sd">        This view returns the URL to which the user should be redirected after</span>
<span class="sd">        a passed or failed puppet attempt.</span>

<span class="sd">        Returns:</span>
<span class="sd">            url (str): Path to post-puppet destination.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the requested character, if it belongs to the authenticated user</span>
        <span class="n">char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="c1"># Get the page the user came from</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">char</span><span class="p">:</span>
            <span class="c1"># If the account owns the char, store the ID of the char in the</span>
            <span class="c1"># Django request&#39;s session (different from Evennia session!).</span>
            <span class="c1"># We do this because characters don&#39;t serialize well.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;puppet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You become &#39;</span><span class="si">%s</span><span class="s2">&#39;!&quot;</span> <span class="o">%</span> <span class="n">char</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the puppeting failed, clear out the cached puppet value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;puppet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You cannot become &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="n">char</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">next_page</span></div></div>


<div class="viewcode-block" id="CharacterManageView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterManageView">[docs]</a><span class="k">class</span> <span class="nc">CharacterManageView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">CharacterMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view provides a mechanism by which a logged-in player can browse,</span>
<span class="sd">    edit, or delete their own characters.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/character_manage_list.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Manage Characters&quot;</span></div>


<div class="viewcode-block" id="CharacterUpdateView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterUpdateView">[docs]</a><span class="k">class</span> <span class="nc">CharacterUpdateView</span><span class="p">(</span><span class="n">CharacterMixin</span><span class="p">,</span> <span class="n">ObjectUpdateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view provides a mechanism by which a logged-in player (enforced by</span>
<span class="sd">    ObjectUpdateView) can edit the attributes of a character they own.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">website_forms</span><span class="o">.</span><span class="n">CharacterUpdateForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/character_form.html&quot;</span></div>


<div class="viewcode-block" id="CharacterDetailView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterDetailView">[docs]</a><span class="k">class</span> <span class="nc">CharacterDetailView</span><span class="p">(</span><span class="n">CharacterMixin</span><span class="p">,</span> <span class="n">ObjectDetailView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view provides a mechanism by which a user can view the attributes of</span>
<span class="sd">    a character, owned by them or not.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/object_detail.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="c1"># What attributes to display for this object</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">]</span>
    <span class="n">access_type</span> <span class="o">=</span> <span class="s2">&quot;view&quot;</span>

<div class="viewcode-block" id="CharacterDetailView.get_queryset"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterDetailView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will override the Django get_queryset method to return a</span>
<span class="sd">        list of all characters the user may access.</span>

<span class="sd">        Returns:</span>
<span class="sd">            queryset (QuerySet): Django queryset for use in the given view.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="c1"># Return a queryset consisting of characters the user is allowed to</span>
        <span class="c1"># see.</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_type</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="CharacterDeleteView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterDeleteView">[docs]</a><span class="k">class</span> <span class="nc">CharacterDeleteView</span><span class="p">(</span><span class="n">CharacterMixin</span><span class="p">,</span> <span class="n">ObjectDeleteView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view provides a mechanism by which a logged-in player (enforced by</span>
<span class="sd">    ObjectDeleteView) can delete a character they own.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="CharacterCreateView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterCreateView">[docs]</a><span class="k">class</span> <span class="nc">CharacterCreateView</span><span class="p">(</span><span class="n">CharacterMixin</span><span class="p">,</span> <span class="n">ObjectCreateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view provides a mechanism by which a logged-in player (enforced by</span>
<span class="sd">    ObjectCreateView) can create a new character.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/character_form.html&quot;</span>

<div class="viewcode-block" id="CharacterCreateView.form_valid"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.CharacterCreateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook, modified for Evennia.</span>

<span class="sd">        This hook is called after a valid form is submitted.</span>

<span class="sd">        When an character creation form is submitted and the data is deemed valid,</span>
<span class="sd">        proceeds with creating the Character object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get account object creating the character</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">character</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get attributes from the form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">charname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
        <span class="c1"># Create a character</span>
        <span class="n">character</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">charname</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="c1"># Echo error messages to the user</span>
            <span class="p">[</span><span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">character</span><span class="p">:</span>
            <span class="c1"># Assign attributes from form</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">character</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="c1"># Return the user to the character management page, unless overridden</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Your character &#39;</span><span class="si">%s</span><span class="s2">&#39; was created!&quot;</span> <span class="o">%</span> <span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_url</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Call the Django &quot;form failed&quot; hook</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Your character could not be created.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_invalid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div></div>


<span class="c1">#</span>
<span class="c1"># Channel views</span>
<span class="c1">#</span>


<div class="viewcode-block" id="ChannelMixin"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ChannelMixin">[docs]</a><span class="k">class</span> <span class="nc">ChannelMixin</span><span class="p">(</span><span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a &quot;mixin&quot;, a modifier of sorts.</span>

<span class="sd">    Any view class with this in its inheritance list will be modified to work</span>
<span class="sd">    with HelpEntry objects instead of generic Objects or otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHANNEL_TYPECLASS</span><span class="p">,</span>
                              <span class="n">fallback</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FALLBACK_CHANNEL_TYPECLASS</span><span class="p">)</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Channels&quot;</span>

    <span class="c1"># What lock type to check for the requesting user, authenticated or not.</span>
    <span class="c1"># https://github.com/evennia/evennia/wiki/Locks#valid-access_types</span>
    <span class="n">access_type</span> <span class="o">=</span> <span class="s2">&quot;listen&quot;</span>

<div class="viewcode-block" id="ChannelMixin.get_queryset"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ChannelMixin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook; here we want to return a list of only those Channels</span>
<span class="sd">        and other documentation that the current user is allowed to see.</span>

<span class="sd">        Returns:</span>
<span class="sd">            queryset (QuerySet): List of Channels available to the user.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="c1"># Get list of all Channels</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">iterator</span><span class="p">()</span>

        <span class="c1"># Now figure out which ones the current user is allowed to see</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="s2">&quot;listen&quot;</span><span class="p">)]</span>

        <span class="c1"># Re-query and set a sorted list</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">filtered</span></div></div>


<div class="viewcode-block" id="ChannelListView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ChannelListView">[docs]</a><span class="k">class</span> <span class="nc">ChannelListView</span><span class="p">(</span><span class="n">ChannelMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of channels that can be viewed by a user, authenticated</span>
<span class="sd">    or not.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/channel_list.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Channel Index&quot;</span>

    <span class="n">max_popular</span> <span class="o">=</span> <span class="mi">10</span>

<div class="viewcode-block" id="ChannelListView.get_context_data"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ChannelListView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook; we override it to calculate the most popular channels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            context (dict): Django context object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ChannelListView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Calculate which channels are most popular</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;most_popular&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_popular</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="ChannelDetailView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ChannelDetailView">[docs]</a><span class="k">class</span> <span class="nc">ChannelDetailView</span><span class="p">(</span><span class="n">ChannelMixin</span><span class="p">,</span> <span class="n">ObjectDetailView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the log entries for a given channel.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/channel_detail.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="c1"># What attributes of the object you wish to display on the page. Model-level</span>
    <span class="c1"># attributes will take precedence over identically-named db.attributes!</span>
    <span class="c1"># The order you specify here will be followed.</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="c1"># How many log entries to read and display.</span>
    <span class="n">max_num_lines</span> <span class="o">=</span> <span class="mi">10000</span>

<div class="viewcode-block" id="ChannelDetailView.get_context_data"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ChannelDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook; before we can display the channel logs, we need to recall</span>
<span class="sd">        the logfile and read its lines.</span>

<span class="sd">        Returns:</span>
<span class="sd">            context (dict): Django context object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the parent context object, necessary first step</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ChannelDetailView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Get the filename this Channel is recording to</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;log_file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;channel_</span><span class="si">%s</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">key</span>
        <span class="p">)</span>

        <span class="c1"># Split log entries so we can filter by time</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tail_log_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_lines</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">log</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">time</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; [-] &quot;</span><span class="p">)</span>
            <span class="n">time_key</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">bucket</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">time_key</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>

        <span class="c1"># Add the processed entries to the context</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;object_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket</span>

        <span class="c1"># Get a list of unique timestamps by hour and sort them</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;object_filters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="ChannelDetailView.get_object"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.ChannelDetailView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override of Django hook that retrieves an object by slugified channel</span>
<span class="sd">        name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            channel (Channel): Channel requested in the URL.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the queryset for the help entries the user can access</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="c1"># Find the object in the queryset</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;slug&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">queryset</span> <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">db_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">channel</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Check if this object was requested in a valid manner</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span>
                <span class="s2">&quot;No </span><span class="si">%(verbose_name)s</span><span class="s2"> found matching the query&quot;</span>
                <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span></div></div>


<span class="c1">#</span>
<span class="c1"># Help views</span>
<span class="c1">#</span>


<div class="viewcode-block" id="HelpMixin"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.HelpMixin">[docs]</a><span class="k">class</span> <span class="nc">HelpMixin</span><span class="p">(</span><span class="n">TypeclassMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a &quot;mixin&quot;, a modifier of sorts.</span>

<span class="sd">    Any view class with this in its inheritance list will be modified to work</span>
<span class="sd">    with HelpEntry objects instead of generic Objects or otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">HelpEntry</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Help&quot;</span>

<div class="viewcode-block" id="HelpMixin.get_queryset"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.HelpMixin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook; here we want to return a list of only those HelpEntries</span>
<span class="sd">        and other documentation that the current user is allowed to see.</span>

<span class="sd">        Returns:</span>
<span class="sd">            queryset (QuerySet): List of Help entries available to the user.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="c1"># Get list of all HelpEntries</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">iterator</span><span class="p">()</span>

        <span class="c1"># Now figure out which ones the current user is allowed to see</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="s2">&quot;view&quot;</span><span class="p">)]</span>

        <span class="c1"># Re-query and set a sorted list</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;db_help_category&quot;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered</span></div></div>


<div class="viewcode-block" id="HelpListView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.HelpListView">[docs]</a><span class="k">class</span> <span class="nc">HelpListView</span><span class="p">(</span><span class="n">HelpMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of help entries that can be viewed by a user, authenticated</span>
<span class="sd">    or not.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/help_list.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Help Index&quot;</span></div>


<div class="viewcode-block" id="HelpDetailView"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.HelpDetailView">[docs]</a><span class="k">class</span> <span class="nc">HelpDetailView</span><span class="p">(</span><span class="n">HelpMixin</span><span class="p">,</span> <span class="n">EvenniaDetailView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the detail page for a given help entry.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/help_detail.html&quot;</span>

<div class="viewcode-block" id="HelpDetailView.get_context_data"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.HelpDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds navigational data to the template to let browsers go to the next</span>
<span class="sd">        or previous entry in the help list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            context (dict): Django context object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">HelpDetailView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Get the object in question</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="c1"># Get queryset and filter out non-related categories</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db_help_category</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">db_help_category</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">queryset</span>

        <span class="c1"># Find the index position of the given obj in the queryset</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Find the previous and next topics, if either exist</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_previous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_previous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Format the help entry using HTML instead of newlines</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_entrytext</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;entry_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="HelpDetailView.get_object"><a class="viewcode-back" href="../../../../api/evennia.web.website.views.html#evennia.web.website.views.HelpDetailView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override of Django hook that retrieves an object by category and topic</span>
<span class="sd">        instead of pk and slug.</span>

<span class="sd">        Returns:</span>
<span class="sd">            entry (HelpEntry): HelpEntry requested in the URL.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the queryset for the help entries the user can access</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="c1"># Find the object in the queryset</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topic&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">queryset</span>
                <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">db_help_category</span><span class="p">)</span> <span class="o">==</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">slugify</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">db_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">topic</span>
            <span class="p">),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check if this object was requested in a valid manner</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span>
                <span class="s2">&quot;No </span><span class="si">%(verbose_name)s</span><span class="s2"> found matching the query&quot;</span>
                <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<h3>Versions</h3>
<ul>
  <li><a href="../../../../../1.0-dev/index.html">1.0-dev (develop branch)</a></li>
  <li><a href="views.html">0.9.5 (v0.9.5 branch)</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia 0.9.5</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.web.website.views</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>